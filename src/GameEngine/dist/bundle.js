(()=>{"use strict";var t,e={d:(t,s)=>{for(var i in s)e.o(s,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:s[i]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},s={};e.r(s),e.d(s,{Decoder:()=>re,Encoder:()=>ne,PacketType:()=>ie,protocol:()=>se});class i{enabled=!0;gameObject;start(){}event(t,e){}getGameWorld(){return this.gameObject.getGameWorld()}hasComponent(t){return this.gameObject.hasComponent(t)}getComponent(t){return this.gameObject.getComponent(t)}getAllComponents(){return this.gameObject.getAllComponents()}getTransform(){return this.gameObject.getTransform()}getGameObject(){return this.gameObject}getPlugin(t){return this.getGameWorld().getPlugin(t)}isEnabled(){return this.gameObject.enabled&&this.enabled}enable(t=!0){this.enabled=t}}class n{static symRand(t){return(2*Math.random()-1)*t}static getColliderRadius(t,e){if(t>=10)return e;const s=Math.PI/t;return(Math.cos(s)*e*2+e)/3}static deltaAngle(t,e){return t=t%(2*Math.PI)+2*Math.PI,t%=2*Math.PI,((e=(e=e%(2*Math.PI)+2*Math.PI)%(2*Math.PI)+2*Math.PI)-t+Math.PI)%(2*Math.PI)-Math.PI}static elasticCollision1D(t,e,s,i){return[(e*(t-s)+2*s*i)/(t+s),(i*(s-t)+2*t*e)/(t+s)]}}class o{x=0;y=0;constructor(t,e){this.x=t,this.y=e}add(t){return new o(this.x+t.x,this.y+t.y)}sub(t){return new o(this.x-t.x,this.y-t.y)}times(t){return new o(this.x*t,this.y*t)}distance(t){return Math.sqrt(Math.pow(this.x-t.x,2)+Math.pow(this.y-t.y,2))}static distance(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))}magnitude(){return Math.sqrt(Math.pow(this.x,2)+Math.pow(this.y,2))}cross(){return new o(this.y,-this.x).toUnit()}scalarProduct(t){return this.x*t.x+this.y*t.y}vectorProduct(t){return this.x*t.y-this.y*t.x}perpendicular(t){return this.sub(t.cross().times(t.scalarProduct(this)/(t.magnitude()*t.magnitude())))}toUnit(){return 0!=this.magnitude()?new o(this.x,this.y).times(1/this.magnitude()):new o(1,0)}setLength(t){return this.toUnit().times(t)}toString(){return"{"+this.x+":"+this.y+"}"}toRad(){return Math.atan2(this.y,this.x)}reverse(){let t=1e32,e=1e32;return 0!=this.x&&(t=1/this.x),0!=this.y&&(e=1/this.y),new o(t,e)}static fromRad(t){return new o(Math.cos(t),Math.sin(t))}static randomPos(t){return new o(n.symRand(t),n.symRand(t))}static randomPos2(t){let e=n.symRand(Math.PI),s=Math.random()*t;return o.fromRad(e).times(s)}clone(){return new o(this.x,this.y)}static zero(){return new o(0,0)}static one(){return new o(1,1)}static up(){return new o(0,1)}static down(){return new o(0,-1)}static left(){return new o(-1,0)}static right(){return new o(1,0)}}class r extends i{velocity;acceleration=o.zero();mass=1;drag;angularVelocity=0;angularAcceleration=0;angularDrag=.01;constructor(t,e=.01){super(),this.velocity=new o(15*Math.random()*2-15,15*Math.random()*2-15),this.drag=e,this.mass=t}update(t){}fixedUpdate(t){this.getTransform().position=this.getTransform().position.add(this.velocity.times(t)),this.getTransform().rotation+=this.angularVelocity*t,this.velocity=this.velocity.add(this.acceleration.times(t)).times(1-this.drag),this.angularVelocity=(this.angularVelocity+this.angularAcceleration*t)*(1-this.angularDrag)}}class a{r=0;g=0;b=0;a=1;static stroke=new a(43,43,44);static background=new a(93,97,95);constructor(t,e,s,i=1){this.r=Math.min(255,Math.max(0,t)),this.g=Math.min(255,Math.max(0,e)),this.b=Math.min(255,Math.max(0,s)),this.a=Math.min(1,Math.max(0,i))}toString(){return`rgba(${this.r},${this.g},${this.b},${Math.max(0,Math.min(this.a,1))})`}toRgb(){return new a(this.r,this.g,this.b)}toArgb(t){return new a(this.r,this.g,this.b,t)}blend(t,e){return new a(this.r*(1-e)+t.r*e,this.g*(1-e)+t.g*e,this.b*(1-e)+t.b*e,this.a*(1-e)+t.a*e)}static randomColor(){return new a(255*Math.random(),255*Math.random(),255*Math.random())}static hslToRgb(t,e,s){s/=100;const i=e=>(e+t/30)%12,n=(e/=100)*Math.min(s,1-s),o=t=>s-n*Math.max(-1,Math.min(i(t)-3,Math.min(9-i(t),1))),r=Math.round(255*o(0)),h=Math.round(255*o(8)),c=Math.round(255*o(4));return new a(r,h,c)}static randomColor2(){const t=Math.floor(360*Math.random()),e=Math.floor(30*Math.random())+15,s=Math.floor(15*Math.random())+30;return a.hslToRgb(t,e,s)}static getHeatmapColor(t){t=Math.max(0,Math.min(1,t));let e=Math.min(255,Math.max(0,Math.floor(255*t*2))),s=Math.min(255,Math.max(0,Math.floor(255*(2-2*t))));return new a(s/1.5,e/1.5,0,255)}clone(){return new a(this.r,this.g,this.b,this.a)}}class h{position;rotation;scale;constructor(t=new o(0,0),e=0,s=o.one()){this.position=t,this.rotation=e,this.scale=s}static fromPosition(t){let e=new h;return e.position=t,e}clone(){let t=new h;return t.position=this.position.clone(),t.scale=this.scale.clone(),t.rotation=this.rotation,t}}class c{transform=new h;components=new Map;enabled=!0;name="UnnamedGameObject";gameWorld;constructor(...t){for(let e of t){let t=e.constructor.name;if(this.components.has(t))throw new Error(`Component ${t} already exists in the game object`);e.gameObject=this,this.components.set(t,e)}}hasComponent(t){return this.components.has(t.name)}getComponent(t){const e=t.name;return this.components.get(e)}getAllComponents(t=!1){return Array.from(this.components.values()).filter((e=>!t||e.isEnabled()))}destroy(){this.gameWorld.destroy(this)}spawn(t){return t.spawn(this)}getTransform(){return this.transform}getGameWorld(){return this.gameWorld}}class l{gameWorld;enabled=!0;name="Plugin";event(t,e){}start(){}update(t){}fixedUpdate(t){}getPlugin(t){return this.gameWorld.getPlugin(t)}hasPlugin(t){return this.gameWorld.hasPlugin(t)}isEnabled(){return this.enabled}enable(t=!0){this.enabled=t}disable(){this.enabled=!1}}class d{constructor(){}}class u{subs=new Map;args=[];subscribe(t,e){this.subs.set(new WeakRef(t),e)}unsubscribe(t){this.subs.delete(new WeakRef(t))}emit(t){this.args.push(t)}register(t){t.registerEvent(this)}invoke(){if(0!=this.args.length){for(const[t,e]of this.subs){const s=t.deref();if(s)for(const t of this.args)s.event(t,e);else this.subs.delete(t)}this.args=[]}}}class p extends d{collider;constructor(t){super(),this.collider=t}}class g extends i{offset=o.zero();radius;isActive=!1;isStatic;avoidObjectes;collisions=new Set;onCollisionEnterEvent=new u;onCollisionExitEvent=new u;constructor(t=1,e=!0,...s){super(),this.radius=t,this.isStatic=e,this.avoidObjectes=new Set,s.forEach((t=>this.avoidObjectes.add(t)))}start(){this.onCollisionEnterEvent.register(this.getGameWorld()),this.onCollisionExitEvent.register(this.getGameWorld())}getCenter(){return this.getTransform().position.add(this.offset)}collides(t){return this.getCenter().sub(t.getCenter()).magnitude()<=this.radius+t.radius&&!this.avoidObjectes.has(t.getGameObject())&&!t.avoidObjectes.has(this.getGameObject())}onCollisionEnter(t){this.onCollisionEnterEvent.emit(new p(t))}onCollisionExit(t){this.onCollisionExitEvent.emit(new p(t))}}class f extends i{zindex;constructor(t=0){super(),this.zindex=t}}class m extends f{color;radius;n;constructor(t,e=4,s=0,i=a.randomColor2()){super(),this.radius=t,this.n=e,this.zindex=s,this.color=i}render(t){const e=[t.canvas.width,t.canvas.height],s=this.getTransform().position.x,i=this.getTransform().position.y,n=this.getTransform().rotation,o=this.getTransform().scale,r=this.getGameWorld().getPlugin(P).scale,a=this.getGameWorld().getPlugin(P).cameraPositon.x,h=this.getGameWorld().getPlugin(P).cameraPositon.y,c=this.color.toString(),l=s-a,d=-(i-h);t.save(),t.translate(e[0]/2,e[1]/2),t.scale(r,r),t.translate(l,d),t.rotate(n),t.scale(o.x,o.y);const u=this.radius;if(this.n<10){t.beginPath(),t.moveTo(0,u);const e=2*Math.PI/this.n;for(let s=1;s<this.n;s++)t.lineTo(Math.sin(s*e)*u,Math.cos(s*e)*u);t.closePath()}else t.beginPath(),t.arc(0,0,u,0,2*Math.PI),t.closePath();t.fillStyle=c,t.shadowBlur=0,t.fill(),t.shadowBlur=50,t.stroke(),t.restore()}}class y extends f{color;constructor(t=0,e=a.background.clone()){super(),this.zindex=t,this.color=e}render(t){const e=this.getComponent(b).length,s=this.getComponent(b).width,i=[t.canvas.width,t.canvas.height],n=this.getTransform().position.x,o=this.getTransform().position.y,r=this.getTransform().scale,h=this.getGameWorld().getPlugin(P).scale,c=this.getGameWorld().getPlugin(P).cameraPositon.x,l=this.getGameWorld().getPlugin(P).cameraPositon.y,d=this.color.toString(),u=(this.getComponent(m).color.toString(),n-c),p=o-l,g=this.getComponent(b),f=Math.sin(Math.min(1,g.getShotDelta()/g.cooldown)*Math.PI),y=(g.range,g.direction.times(g.bulletSpeed).times(g.getBulletLifetime()).add(g.getGlobalOffset()));t.save(),t.translate(i[0]/2,i[1]/2),t.scale(h,-h),t.translate(u,p),t.translate(y.x,y.y),t.beginPath(),t.arc(0,0,1,0,2*Math.PI),t.closePath(),t.shadowBlur=0,t.strokeStyle=a.stroke.toString(),t.stroke(),t.strokeRect(-.5,-.5,1,1),t.restore(),t.save(),t.translate(i[0]/2,i[1]/2),t.scale(h,-h),t.translate(u,p),t.scale(r.x,r.y),t.rotate(g.direction.toRad()),t.beginPath(),t.roundRect(0,-s/2,(1-f/3)*e,s,.1),t.closePath(),t.fillStyle=d,t.shadowBlur=0,t.fill(),t.shadowBlur=30,t.stroke(),t.restore()}}class w extends i{tickCount=0;tick(t){0==this.tickCount?this.start():this.update(t),this.tickCount++}start(){}update(t){}}class b extends w{damage;cooldown=.15;bulletSpeed=40;length;width;range=250;bulletSpraed=.1;offset;direction=o.right();targetDirection=o.right();lastShootTime=-10;constructor(t=4,e=2,s=10){super(),this.damage=s,this.length=t,this.width=e,this.offset=new o(t-e/2,0)}getShotDelta(){return this.getGameWorld().getWorldTime()-this.lastShootTime}update(t){let e=this.direction.toRad(),s=this.targetDirection.toRad();e+=9*t*n.deltaAngle(e,s),this.direction=o.fromRad(e)}getBulletLifetime(){return this.range/this.bulletSpeed}getGlobalOffset(){return this.direction.toUnit().times(this.offset.x).add(this.direction.cross().times(this.offset.y))}shoot(){if(this.isEnabled&&this.getGameObject().enabled&&this.getShotDelta()>=this.cooldown){const t=.125,e=this.getComponent(y).zindex-.01;let s=D.bulletGO(this.getGameObject(),this.damage,this.width/2+n.symRand(t),this.getBulletLifetime(),e),i=s.getComponent(r),o=s.getComponent(g);s.getComponent(m).color=this.getComponent(m).color.clone(),o.avoidObjectes.add(this.getGameObject()),s.getTransform().position=this.getTransform().position.add(this.getGlobalOffset());let a=this.direction.cross().times(2*Math.random()*this.bulletSpraed-this.bulletSpraed);i.velocity=this.direction.toUnit().add(a).times(this.bulletSpeed),s.spawn(this.getGameWorld()),this.lastShootTime=this.getGameWorld().getWorldTime()}}}class v extends d{key;constructor(t){super(),this.key=t}}class _ extends l{name="CameraPlugin";prevPressedKeys=new Set;pressedKeys=new Set;KeyDownEvent=new u;constructor(t){super(),this.pressedKeys=t}isPressed(t){return this.pressedKeys.has(t)}start(){this.KeyDownEvent.register(this.gameWorld)}update(t){this.pressedKeys.difference(this.prevPressedKeys).forEach((t=>this.KeyDownEvent.emit(new v(t)))),this.prevPressedKeys.clear(),this.pressedKeys.forEach((t=>this.prevPressedKeys.add(t)))}}class C extends l{name="MousePlugin";pressedKeys=new Set;canvas;position=o.zero();constructor(t){super(),this.canvas=t,this.trackMouse(t)}scroll(t){let e=this.getPlugin(P);(t=Math.sign(t))>0&&.9*e.targetScale>5&&(e.targetScale=.9*e.targetScale),t<0&&1.1*e.targetScale<100&&(e.targetScale=1.1*e.targetScale)}isKeyDown(t=0){return this.pressedKeys.has(t)}getWorldPosition(){let t=this.getPlugin(P).scale,e=this.getPlugin(P).cameraPositon;const s=new o(this.canvas.width,this.canvas.height);return new o((this.position.x-s.x/2)/t,(-this.position.y+s.y/2)/t).add(e)}trackMouse(t){t.addEventListener("mousemove",(e=>{const s=t.getBoundingClientRect();let i=e.clientX-s.left,n=e.clientY-s.top;this.position=new o(i,n)})),t.addEventListener("mousedown",(t=>{this.pressedKeys.add(t.button)})),t.addEventListener("mouseup",(t=>{this.pressedKeys.delete(t.button)})),t.addEventListener("wheel",(t=>{this.scroll(t.deltaY)}))}}class x extends l{name="ConfigPlugin";config=new Map([["bulletSize",.75],["playerSize",2.5],["bulletColor",new a(56,57,60)],["playerColor",new a(122,111,62)],["playerColor",new a(80,37,36)],["playerColor",new a(59,94,76)],["playerColor",new a(129,49,54)],["playerColor",new a(130,111,51)]]);get(t){if(this.config.has(t))return this.config.get(t)}set(t,e){this.config.set(t,e)}}class k extends l{name="PlayerPlugin";player=D.playerGO();getPlayerPosition(){return this.player.getTransform().position.clone()}getPlayerColor(){return this.player.getComponent(m).color.clone()}start(){this.player.spawn(this.gameWorld),this.player.name="player",this.player.getComponent(m).color=this.getPlugin(x)?.get("playerColor")??new a(53,110,58),this.getPlugin(_).KeyDownEvent.subscribe(this,"KeyDownEvent")}event(t,e){if(!this.player.enabled||!this.enabled)return;let s=t;if("r"===s.key)this.player&&this.gameWorld.isSpawned(this.player)&&this.gameWorld.destroy(this.player),this.player=D.playerGO(),this.player.spawn(this.gameWorld);else if("c"===s.key){let t=this.getPlugin(x)?.get("displayColliders")??!1;void 0!==t&&this.getPlugin(x)?.set("displayColliders",!t)}}update(t){if(!this.player.enabled||!this.enabled)return;let e=this.getPlugin(C),s=this.getPlugin(_),i=this.player.getComponent(b);i.targetDirection=e.getWorldPosition().sub(this.player.getTransform().position),i.range=e.getWorldPosition().sub(this.player.getTransform().position.add(i.getGlobalOffset())).magnitude(),(s.isPressed("e")||e.isKeyDown(0))&&i.shoot()}fixedUpdate(t){if(!this.player.enabled||!this.enabled)return;let e=150;const s=this.getPlugin(_),i=this.player.getTransform().rotation,n=o.fromRad(i);let a=this.player.getComponent(r),h=a.velocity;s.isPressed("shift")&&(e=250),s.isPressed("w")?(a.acceleration=n.toUnit().times(e),s.isPressed("s")&&(a.acceleration=n.toUnit().times(55))):s.isPressed("s")?a.acceleration=n.toUnit().times(-55):a.acceleration=o.zero(),h=h.sub(h.perpendicular(n)),h.magnitude()>50&&h.setLength(50),s.isPressed("a")?a.angularVelocity=2.5:s.isPressed("d")?a.angularVelocity=-2.5:a.angularVelocity=0}}class P extends l{cameraPositon=new o(4,0);scale=20;targetScale=40;name="CameraPlugin";start(){let t=this.getPlugin(k).getPlayerPosition();this.cameraPositon=t.clone()}fixedUpdate(t){let e=this.getPlugin(k).getPlayerPosition();this.scale+=(this.targetScale-this.scale)*(2.5*t),this.cameraPositon=this.cameraPositon.add(e.sub(this.cameraPositon).times(.02))}}class T extends f{color=new a(42,42,55);text;displayName;constructor(t,e=!1,s=1){super(),this.text=t,this.zindex=s,this.displayName=e}render(t){const e=[t.canvas.width,t.canvas.height],s=this.getTransform().position.x,i=this.getTransform().position.y,n=(this.getTransform().rotation,this.getTransform().scale),o=this.getGameWorld().getPlugin(P).scale,r=this.getGameWorld().getPlugin(P).cameraPositon.x,a=this.getGameWorld().getPlugin(P).cameraPositon.y,h=this.color.toString(),c=s-r,l=-(i-a);t.save(),t.fillStyle=h,t.translate(e[0]/2,e[1]/2),t.scale(o,o),t.translate(c,l),t.scale(n.x,n.y);const d=this.displayName?this.getGameObject().name:this.text;t.font="bold 1px Arial",t.fillStyle="azure";const u=t.measureText(d).width/2;t.strokeText(d,-u,1/4),t.fillText(d,-u,1/4),t.restore()}}class E extends f{activeColor=new a(172,42,55,.125);staticColor=new a(95,64,36,.125);dynamicColor=new a(57,127,31,.125);disabledColor=new a(36,24,36,.125);constructor(t=-1){super(),this.zindex=t}getColor(){let t=this.dynamicColor,e=this.getComponent(g);return e.isEnabled()?e.isActive?t=this.activeColor:e.isStatic&&(t=this.staticColor):t=this.disabledColor,t}render(t){if(!this.getPlugin(x)?.get("displayColliders"))return;const e=this.getComponent(g),s=e.offset,i=e.radius+.25,n=this.getColor(),o=[t.canvas.width,t.canvas.height],r=this.getTransform().position.x+s.x,a=this.getTransform().position.y+s.y,h=this.getTransform().rotation,c=this.getGameWorld().getPlugin(P).scale,l=i,d=r-this.getGameWorld().getPlugin(P).cameraPositon.x,u=-(a-this.getGameWorld().getPlugin(P).cameraPositon.y);t.save(),t.translate(o[0]/2,o[1]/2),t.scale(c,c),t.translate(d,u),t.rotate(h),t.strokeStyle=n.toRgb().toString(),t.fillStyle=n.toString(),t.shadowBlur=30,t.beginPath(),t.arc(0,0,l,0,2*Math.PI),t.closePath(),t.fill(),t.stroke(),t.restore()}}class S{progress=-1;duration=.25;startAnimation=()=>{};endAnimation=()=>{};updateAnimation=()=>{};constructor(t=()=>{},e=()=>{},s=()=>{}){this.updateAnimation=t,this.startAnimation=e,this.endAnimation=s}update(t){if(this.progress>0){let e=(this.duration-this.progress)/this.duration;this.progress-=t,this.updateAnimation(e)}else-1!=this.progress&&(this.endAnimation(),this.progress=-1)}start(){-1==this.progress?(this.startAnimation(),this.progress=this.duration):this.progress=(this.duration+this.progress)/2}}class O extends w{shrinkAnimation=new S;zoomAnimation=new S;defaultZoom=new o(1,1);constructor(){super(),this.shrinkAnimation=new S((t=>this.getTransform().scale=this.defaultZoom.times(1-t)),(()=>this.getComponent(M)?.enable(!1)),(()=>this.getGameObject().destroy())),this.zoomAnimation=new S((t=>this.getTransform().scale=this.defaultZoom.times(1+Math.sin(Math.PI*t)/5)),(()=>this.defaultZoom=this.getTransform().scale.clone()),(()=>this.getTransform().scale=this.defaultZoom))}update(t){this.shrinkAnimation.update(t),this.zoomAnimation.update(t)}startZoom(){this.zoomAnimation.start()}startShrink(){this.shrinkAnimation.start()}}class A extends d{damage;participant;constructor(t,e){super(),this.damage=t,this.participant=e}}class R extends i{health;maxHealth;damageEvent;constructor(t,e=t){super(),this.health=e,this.maxHealth=t,this.damageEvent=new u}start(){this.damageEvent.register(this.getGameWorld()),this.getComponent(g).onCollisionEnterEvent.subscribe(this,"onCollisionEnter")}event(t){let e=t;this.onCollisionEnter(e.collider)}onCollisionEnter(t){let e=t.getGameObject(),s=e.getComponent(r),i=this.getComponent(r),n=i.mass/(s.mass+i.mass);i.mass<s.mass&&(s.velocity=s.velocity.add(i.velocity.times(n)).times(.5),i.velocity=i.velocity.add(s.velocity.times(1-n).times(.5))),s.angularVelocity-=this.getTransform().position.sub(e.getTransform().position).vectorProduct(i.velocity)*(n/15);try{const t=e.getComponent(R),s=Math.min(t.health,this.health);if(0==s)return;this.onDamage(s,t),t.onDamage(s,this)}catch{}}getHealth(){return this.health/this.maxHealth}heal(t){this.health=Math.min(this.maxHealth,this.health+t)}onDamage(t,e){if(this.health-=t,this.damageEvent.emit(new A(t,e)),0==this.health){if(this.getComponent(g)?.enable(!1),this.getComponent(r).drag=.025,this.getComponent(O)?.startShrink(),e.hasComponent(m)){let t=this.getComponent(m).color.blend(e.getComponent(m).color.toRgb(),.5);this.getComponent(m).color=t,e.getComponent(m).color=t}}else this.getComponent(O)?.startZoom()}}class M extends f{offset=new o(0,4);fill=.5;width=5;height=.5;constructor(t=0){super(t)}render(t){let e=this.width,s=this.fill;try{s=this.getComponent(R).getHealth(),e=2+this.getComponent(R).maxHealth/250}catch{}if(s>=1||s<=0)return;const i=[t.canvas.width,t.canvas.height],n=this.getTransform().position.x,o=this.getTransform().position.y,r=this.getTransform().scale,h=this.getGameWorld().getPlugin(P).scale,c=this.getGameWorld().getPlugin(P).cameraPositon.x,l=this.getGameWorld().getPlugin(P).cameraPositon.y,d=a.getHeatmapColor(s).toString(),u=n-c,p=-(o-l),g=.25;t.save(),t.translate(i[0]/2,i[1]/2),t.scale(h,h),t.translate(u,p),t.scale(r.x,r.y),t.translate(this.offset.x,-this.offset.y),t.fillStyle=d,t.shadowBlur=0,t.beginPath(),t.roundRect(-e/2,-this.height/2,e,this.height,g),t.closePath(),t.fillStyle=a.background.toString(),t.fill(),t.beginPath(),t.roundRect(-e/2,-this.height/2,e*s,this.height,g),t.closePath(),t.fillStyle=d,t.fill(),t.beginPath(),t.roundRect(-e/2,-this.height/2,e,this.height,g),t.closePath(),t.shadowBlur=30,t.stroke(),t.beginPath(),t.roundRect(-e/2,-this.height/2,e*s,this.height,g),t.closePath(),t.shadowBlur=0,t.stroke(),t.restore()}}class B extends l{name="SchedulerPlugin";schedule=[];addInvoke(t,e,s){let i=new WeakRef(t);this.schedule.push({totalTime:e,subscriber:i,topic:s}),this.schedule.sort(((t,e)=>e.totalTime-t.totalTime))}update(t){const e=this.gameWorld.getWorldTime();if(0!=this.schedule.length)for(;0!=this.schedule.length&&this.schedule[this.schedule.length-1].totalTime<=e;){let t=this.schedule.pop();t.subscriber.deref()?.onInvoke(t.topic)}}}class W extends i{lifeTime;constructor(t=1){super(),this.lifeTime=t}onInvoke(t){this.getComponent(O)?.startShrink()}start(){let t=this.getGameWorld().getWorldTime()+this.lifeTime;this.getGameWorld().getPlugin(B).addInvoke(this,t,"destroy")}}class L extends i{owner;constructor(t){super(),this.owner=new WeakRef(t)}getOwner(){return this.owner.deref()}}class j extends f{color;constructor(t=0,e=new a(22,24,25)){super(),this.zindex=t,this.color=e}render(t){const e=[t.canvas.width,t.canvas.height],s=this.getTransform().position.x,i=this.getTransform().position.y,n=this.getTransform().rotation,o=this.getTransform().scale,r=this.getGameWorld().getPlugin(P).scale,h=this.getGameWorld().getPlugin(P).cameraPositon.x,c=this.getGameWorld().getPlugin(P).cameraPositon.y,l=(this.color.toString(),s-h),d=i-c;t.save(),t.translate(e[0]/2,e[1]/2),t.scale(r,-r),t.translate(l,d),t.rotate(n),t.scale(o.x,o.y),t.beginPath(),t.fillStyle=this.getComponent(m).color.toString(),t.shadowBlur=0,t.roundRect(-4,-2,8,4,1),t.fill(),t.shadowBlur=50,t.stroke(),t.closePath(),t.beginPath(),t.fillStyle=a.background.toString(),t.shadowBlur=0,t.roundRect(-4.5,-3.25,10,2,.5),t.fill(),t.shadowBlur=50,t.stroke(),t.closePath(),t.beginPath(),t.shadowBlur=0,t.roundRect(-4.5,1.25,10,2,.5),t.fill(),t.shadowBlur=50,t.stroke(),t.closePath(),t.beginPath(),t.fillStyle=a.background.toString(),t.shadowBlur=0,t.roundRect(-3,-2,6,4,1.5),t.fill(),t.shadowBlur=50,t.stroke(),t.closePath(),t.restore()}}class N extends f{color;traces=[];lastPosition=o.zero();transparency=2;duration=1;length=2;constructor(t=0,e=new a(66,83,68)){super(),this.zindex=t,this.color=e}render(t){const e=[t.canvas.width,t.canvas.height],s=this.getGameWorld().getPlugin(P).scale,i=this.getGameWorld().getPlugin(P).cameraPositon.x,n=this.getGameWorld().getPlugin(P).cameraPositon.y,o=this.getTransform().position.clone(),r=this.getTransform().rotation;for(this.lastPosition.distance(o)>.75&&(this.traces.push({position:o,rotation:r,startTime:this.getGameWorld().getWorldTime()}),this.lastPosition=this.getTransform().position.clone());this.traces.length>0&&this.traces[0].startTime+this.duration<this.getGameWorld().getWorldTime();)this.traces.shift();for(const o of this.traces){const r=o.position.x-i,a=o.position.y-n,h=1-(this.getGameWorld().getWorldTime()-o.startTime)/this.duration;t.save(),t.translate(e[0]/2,e[1]/2),t.scale(s,-s),t.translate(r,a),t.rotate(o.rotation),t.beginPath(),t.fillStyle=this.color.toArgb(this.transparency*h).toString(),t.shadowBlur=0,t.roundRect(-4.5,-3.25,this.length,2,.75),t.fill(),t.closePath(),t.beginPath(),t.roundRect(-4.5,1.25,this.length,2,.75),t.fill(),t.closePath(),t.restore()}}}class D{static polygonGO(t=2,e=3,...s){let i=new c(new r(.1,.01),new m(t,e,0,a.randomColor2().toArgb(.75)),new M(.1),new g(n.getColliderRadius(e,t)),new E,new R(25*e),new O,...s);return i.getTransform().rotation=2*Math.random()*Math.PI,i.name="Polygon",i}static enemyGO(t=2.5,e="",s=4,...i){let a=new c(new T(e,void 0,s+.1),new m(t,8,s),new M(s+.1),new j(s-.2),new r(30,.01),new g(t,!1),new E(s-.15),new R(1500),new O,new N(-21.37),...i);return a.getTransform().rotation=n.symRand(Math.PI),a.getComponent(r).angularDrag=1,a.getComponent(b).targetDirection=o.fromRad(n.symRand(Math.PI)),a.name="Enemy",a}static bulletGO(t,e=30,s=.65,i=1,n=-1,...o){let h=new c(new r(.05,0),new m(s,10,n,new a(173,87,87)),new g(s,!1),new E,new R(e),new O,new W(i),new L(t),...o);return h.getTransform().rotation=0,h.name="Bullet",h}static playerGO(t=2.5,e=5,...s){let i=new c(new j(e-.2),new m(t,10,e,new a(50,99,52)),new T("Player",!0,e+.1),new E(e-.15),new M(e+.1),new y(e-.1),new r(30,.05),new g(t,!1),new R(1e3),new O,new b(6,1.55,44),new N(-21.37),...s);return i.getTransform().rotation=0,i.name="Player",i}}class G extends f{image=new Image;side;offset;constructor(t=o.zero(),e=o.zero(),s="GameEngine/src/Assets/vectorpaint3.svg",i=0){super(),this.zindex=i,this.side=t,this.offset=e,this.image.src=s}render(t){const e=[t.canvas.width,t.canvas.height],s=this.getTransform().position.x,i=this.getTransform().position.y,n=this.getTransform().rotation,o=this.getTransform().scale,r=this.getGameWorld().getPlugin(P).scale,a=s-this.getGameWorld().getPlugin(P).cameraPositon.x,h=-(i-this.getGameWorld().getPlugin(P).cameraPositon.y);let c=this.side;0==c.x&&(c.x=this.image.width),0==c.y&&(c.y=this.image.height),t.save(),t.translate(e[0]/2,e[1]/2),t.scale(r,r),t.translate(a,h),t.rotate(n),t.scale(o.x,o.y),t.translate(this.offset.x,this.offset.y),t.shadowBlur=15,t.drawImage(this.image,-c.x/2,-c.y/2,c.x,c.y),t.restore()}}class q extends l{name="RendererPlugin";context;hud=new I;renderDistance=150;constructor(t){super(),this.context=t}addVignetteEffect(t,e){const s=t.canvas.width/2,i=t.canvas.height/2,n=Math.sqrt(s*s+i*i),o=t.createRadialGradient(s,i,0,s,i,n);o.addColorStop(.25,"rgba(0, 0, 0, 0)"),o.addColorStop(1,e),t.fillStyle=o,t.fillRect(0,0,t.canvas.width,t.canvas.height)}drawDotGrid(t,e,s,i){const n=t.canvas.width,o=t.canvas.height,r=this.getPlugin(P).scale,a=this.getPlugin(P).cameraPositon;e*=r,s*=r,t.fillStyle=i;for(let i=(n/2-a.x*r)%e;i<=n;i+=e)for(let n=(o/2+a.y*r)%e;n<=o;n+=e)t.beginPath(),t.arc(i,n,s/2,0,2*Math.PI),t.fill()}drawGrid(t,e,s){const i=t.canvas.width,n=t.canvas.height,o=this.getPlugin(P).scale,r=this.getPlugin(P).cameraPositon;t.save(),e*=o,t.strokeStyle=s,t.lineWidth=.1*o,t.beginPath();for(let s=(i/2-r.x*o)%e;s<=i;s+=e)t.moveTo(s,0),t.lineTo(s,n);for(let s=(n/2+r.y*o)%e;s<=n;s+=e)t.moveTo(0,s),t.lineTo(i,s);t.stroke(),t.restore()}start(){this.context.imageSmoothingEnabled=!0,this.context.strokeStyle="rgb(43,43,44)",this.context.lineWidth=.175,this.context.lineJoin="round",this.context.shadowColor="rgba(0, 0, 0, 0.75)"}update(t){const e=this.context.canvas.width,s=this.context.canvas.height;this.context.fillStyle="#716f6b",this.context.fillStyle="rgb(85, 106, 86)",this.context.fillRect(0,0,e,s),this.drawGrid(this.context,10,"rgb(43,43,44)"),this.gameWorld.getComponents(T).concat(this.gameWorld.getComponents(E)).concat(this.gameWorld.getComponents(M)).concat(this.gameWorld.getComponents(m)).concat(this.gameWorld.getComponents(G)).concat(this.gameWorld.getComponents(y)).concat(this.gameWorld.getComponents(N)).concat(this.gameWorld.getComponents(j)).filter((t=>t.getTransform().position.distance(this.getPlugin(P).cameraPositon)<this.renderDistance)).sort(((t,e)=>t.zindex-e.zindex)).forEach((t=>t.render(this.context))),this.hud.draw(this.context),this.addVignetteEffect(this.context,"rgba(0, 0, 0, 0.3)")}}class I{texts=new Map;setLabel(t,e,s){this.texts.set(t,{pos:e,text:s})}removeLabel(t){this.texts.delete(t)}draw(t){for(const e of this.texts.values())this.drawText(e.text,e.pos,t)}drawText(t,e,s){s.save(),s.translate(e.x,e.y),s.font="bold 30px Arial",s.fillStyle="azure",s.lineWidth=5.25,s.strokeText(t,-0,7.5),s.fillText(t,-0,7.5),s.restore()}}class U extends l{name="ProfilerPlugin";size=200;usage=new Map;constructor(){super()}addRecord(t,e){if(this.usage.has(t)){let s=this.usage.get(t);s.length>=this.size?(s.shift(),s.push(e)):s.push(e)}else this.usage.set(t,[e])}update(t){let e=0;for(const t of this.usage){let s=t[0],i=t[1].length,n=0;for(const e of t[1])n+=e;n/=i,e++,this.getPlugin(q).hud.setLabel(s,new o(40,40*e),`${s}: `+n.toFixed(2).toString()+"ms")}}}class z{startTime=0;prevWorldTime=0;worldTime=0;tickCount=0;gameObjects=new Set;plugins=new Map;events=new Set;componentsToStart=[];constructor(...t){for(let e of t){let t=e.constructor.name;if(this.plugins.has(t))throw new Error(`Plugin ${t} already exists in the game object`);e.gameWorld=this,this.plugins.set(t,e)}}getPlugin(t){const e=t.name;return this.plugins.get(e)}hasPlugin(t){const e=t.name;return this.plugins.has(e)}isSpawned(t){return this.gameObjects.has(t)}spawn(t){if(this.gameObjects.has(t))throw new Error(`GameObject ${t.name} already exists in the game world`);return t.gameWorld=this,this.gameObjects.add(t),t.getAllComponents().forEach((t=>this.componentsToStart.push(new WeakRef(t)))),t}destroy(t){if(!this.gameObjects.has(t))throw new Error(`GameObject ${t.name} does'not exist in the game world`);t.enabled=!1,this.gameObjects.delete(t)}getAllGameObjects(t=!0){return Array.from(this.gameObjects).filter((e=>e.enabled||!t))}getComponents(t,e=!0){return this.getAllGameObjects().filter((s=>s.hasComponent(t)&&(s.getComponent(t).isEnabled()||!e))).map((e=>e.getComponent(t)))}getAllComponents(t=!0){return Array.from(this.getAllGameObjects(t)).flatMap((t=>t.getAllComponents()))}registerEvent(t){this.events.add(new WeakRef(t))}getWorldTime(){return this.worldTime/1e3}tick(){this.tickCount++,1==this.tickCount?this.startWorld():this.updateWorld(),this.startComponents(),this.invokeEvents()}startComponents(){for(let t of this.componentsToStart){const e=t.deref();e&&e.start()}this.componentsToStart=[]}startWorld(){this.startTime=performance.now(),this.Start(),this.plugins.forEach((t=>t.start())),setInterval((()=>{this.FixedUpdate(.01),this.plugins.forEach((t=>t.fixedUpdate(.01)))}),10)}updateWorld(){this.worldTime=performance.now()-this.startTime;let t=this.worldTime-this.prevWorldTime;this.prevWorldTime=this.worldTime,this.Update(t/1e3),this.plugins.forEach((e=>{let s=performance.now();e.update(t/1e3),this.getPlugin(U).addRecord(e.name,performance.now()-s)}))}invokeEvents(){let t=performance.now();for(const t of this.events){const e=t.deref();e?e.invoke():this.events.delete(t)}this.getPlugin(U).addRecord("Events",performance.now()-t)}Start(){}Update(t){}FixedUpdate(t){}}!function(t){t[t.neutral=0]="neutral",t[t.passive=1]="passive",t[t.aggresive=2]="aggresive"}(t||(t={}));class F extends w{type=t.aggresive;isAttacing=!1;target;isFollowing=!1;minDistance=100;maxDistance=1e3;maxSpeed=10;start(){this.getComponent(R).damageEvent.subscribe(this)}event(t){const e=t.participant;e.hasComponent(L)&&e.getComponent(L).getOwner()&&this.attack(e.getComponent(L).getOwner())}attack(t){this.isAttacing=!0,this.target=new WeakRef(t),this.isFollowing=!0}update(t){if(this.target&&this.target.deref()){if(this.isAttacing){let e=this.getComponent(b),s=this.target.deref().getTransform().position.sub(this.getTransform().position);e.targetDirection=s;let i=s.magnitude();if(i>this.maxDistance&&(this.isAttacing=!1),e.shoot(),i>=this.minDistance){let e=this.getTransform().rotation,i=s.toRad();e+=5*t*n.deltaAngle(e,i),this.getTransform().rotation=e,this.getComponent(r).velocity=o.fromRad(e).times(this.maxSpeed)}}}else this.isAttacing=!1}}class K extends z{Start(){console.log("Hello, MyWorld!");const t=300;for(let e=0;e<350;e++){const e=3+n.symRand(.25);let s=D.polygonGO(e/2,4);s.getTransform().position=o.randomPos(t),s.getComponent(r).angularVelocity=2*Math.random()-1,this.spawn(s)}for(let e=0;e<150;e++){const e=3.5+n.symRand(.25);let s=D.polygonGO(e/2,3);s.getTransform().position=o.randomPos(t),s.getComponent(r).angularVelocity=2*Math.random()-1,this.spawn(s)}for(let e=0;e<150;e++){const e=4+n.symRand(.25);let s=D.polygonGO(e/2,Math.round(3*Math.random())+5);s.getTransform().position=o.randomPos(t),s.getComponent(r).angularVelocity=2*Math.random()-1,this.spawn(s)}for(let e=0;e<25;e++){const e=3+n.symRand(.25);let s=D.polygonGO(e/2,Math.round(3*Math.random())+5,new G(o.zero(),void 0,void 0,12));s.getTransform().position=new o(2*Math.random()*t-t,2*Math.random()*t-t),s.getComponent(r).angularVelocity=2*Math.random()-1,s.getComponent(m).enable(!1),this.spawn(s)}for(let e=0;e<25;e++){let s=D.enemyGO(2.5,"Enemy nr."+e,4,new b(void 0,void 0,10+5*Math.random()),new y(3.9),new F);s.getTransform().position=o.randomPos(t),s.spawn(this)}}Update(t){}}class V extends l{name="PhysicsPlugin";update(t){this.gameWorld.getWorldTime(),this.gameWorld.getComponents(r).forEach((e=>e.update(t)))}fixedUpdate(t){this.gameWorld.getWorldTime(),this.gameWorld.getComponents(r).forEach((e=>e.fixedUpdate(t)))}}class H extends l{name="CollisionDetectionPlugin";cellSize=5;update(){this.checkCollisions()}getCellKey(t){const e=Math.floor(t.x/this.cellSize),s=Math.floor(t.y/this.cellSize);return new o(e,s)}getNearbyCircles(t,e){const s=[];for(let i=-1;i<=1;i++)for(let n=-1;n<=1;n++){const r=new o(i,n),a=t.add(r).toString();e.has(a)&&s.push(...e.get(a))}return s}checkCollisions(){let t=this.gameWorld.getComponents(g),e=new Map;for(const s of t){s.isActive=!1;let t=this.getCellKey(s.getCenter()).toString();e.has(t)?e.get(t).push(s):e.set(t,[s])}for(const t of e.values())for(const s of t){if(s.isStatic)continue;let t=new Set,i=this.getNearbyCircles(this.getCellKey(s.getCenter()),e);for(const e of i)s!==e&&s.collides(e)&&(s.isActive=!0,t.add(e),e.isActive=!0);for(let e of t)s.collisions.has(e)||s.getComponent(g).onCollisionEnter(e);s.collisions.clear(),s.collisions=t}}}class $ extends l{name="StandaloneComponentPlugin";update(t){this.gameWorld.getAllComponents().filter((t=>t instanceof w)).map((t=>t)).forEach((e=>e.tick(t)))}}const Y=Object.create(null);Y.open="0",Y.close="1",Y.ping="2",Y.pong="3",Y.message="4",Y.upgrade="5",Y.noop="6";const J=Object.create(null);Object.keys(Y).forEach((t=>{J[Y[t]]=t}));const X={type:"error",data:"parser error"},Q="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Object.prototype.toString.call(Blob),Z="function"==typeof ArrayBuffer,tt=t=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer instanceof ArrayBuffer,et=({type:t,data:e},s,i)=>Q&&e instanceof Blob?s?i(e):st(e,i):Z&&(e instanceof ArrayBuffer||tt(e))?s?i(e):st(new Blob([e]),i):i(Y[t]+(e||"")),st=(t,e)=>{const s=new FileReader;return s.onload=function(){const t=s.result.split(",")[1];e("b"+(t||""))},s.readAsDataURL(t)};function it(t){return t instanceof Uint8Array?t:t instanceof ArrayBuffer?new Uint8Array(t):new Uint8Array(t.buffer,t.byteOffset,t.byteLength)}let nt;const ot="undefined"==typeof Uint8Array?[]:new Uint8Array(256);for(let t=0;t<64;t++)ot["ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charCodeAt(t)]=t;const rt="function"==typeof ArrayBuffer,at=(t,e)=>{if("string"!=typeof t)return{type:"message",data:ct(t,e)};const s=t.charAt(0);return"b"===s?{type:"message",data:ht(t.substring(1),e)}:J[s]?t.length>1?{type:J[s],data:t.substring(1)}:{type:J[s]}:X},ht=(t,e)=>{if(rt){const s=(t=>{let e,s,i,n,o,r=.75*t.length,a=t.length,h=0;"="===t[t.length-1]&&(r--,"="===t[t.length-2]&&r--);const c=new ArrayBuffer(r),l=new Uint8Array(c);for(e=0;e<a;e+=4)s=ot[t.charCodeAt(e)],i=ot[t.charCodeAt(e+1)],n=ot[t.charCodeAt(e+2)],o=ot[t.charCodeAt(e+3)],l[h++]=s<<2|i>>4,l[h++]=(15&i)<<4|n>>2,l[h++]=(3&n)<<6|63&o;return c})(t);return ct(s,e)}return{base64:!0,data:t}},ct=(t,e)=>"blob"===e?t instanceof Blob?t:new Blob([t]):t instanceof ArrayBuffer?t:t.buffer,lt=String.fromCharCode(30);let dt;function ut(t){return t.reduce(((t,e)=>t+e.length),0)}function pt(t,e){if(t[0].length===e)return t.shift();const s=new Uint8Array(e);let i=0;for(let n=0;n<e;n++)s[n]=t[0][i++],i===t[0].length&&(t.shift(),i=0);return t.length&&i<t[0].length&&(t[0]=t[0].slice(i)),s}function gt(t){if(t)return function(t){for(var e in gt.prototype)t[e]=gt.prototype[e];return t}(t)}gt.prototype.on=gt.prototype.addEventListener=function(t,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+t]=this._callbacks["$"+t]||[]).push(e),this},gt.prototype.once=function(t,e){function s(){this.off(t,s),e.apply(this,arguments)}return s.fn=e,this.on(t,s),this},gt.prototype.off=gt.prototype.removeListener=gt.prototype.removeAllListeners=gt.prototype.removeEventListener=function(t,e){if(this._callbacks=this._callbacks||{},0==arguments.length)return this._callbacks={},this;var s,i=this._callbacks["$"+t];if(!i)return this;if(1==arguments.length)return delete this._callbacks["$"+t],this;for(var n=0;n<i.length;n++)if((s=i[n])===e||s.fn===e){i.splice(n,1);break}return 0===i.length&&delete this._callbacks["$"+t],this},gt.prototype.emit=function(t){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),s=this._callbacks["$"+t],i=1;i<arguments.length;i++)e[i-1]=arguments[i];if(s){i=0;for(var n=(s=s.slice(0)).length;i<n;++i)s[i].apply(this,e)}return this},gt.prototype.emitReserved=gt.prototype.emit,gt.prototype.listeners=function(t){return this._callbacks=this._callbacks||{},this._callbacks["$"+t]||[]},gt.prototype.hasListeners=function(t){return!!this.listeners(t).length};const ft="function"==typeof Promise&&"function"==typeof Promise.resolve?t=>Promise.resolve().then(t):(t,e)=>e(t,0),mt="undefined"!=typeof self?self:"undefined"!=typeof window?window:Function("return this")();function yt(t,...e){return e.reduce(((e,s)=>(t.hasOwnProperty(s)&&(e[s]=t[s]),e)),{})}const wt=mt.setTimeout,bt=mt.clearTimeout;function vt(t,e){e.useNativeTimers?(t.setTimeoutFn=wt.bind(mt),t.clearTimeoutFn=bt.bind(mt)):(t.setTimeoutFn=mt.setTimeout.bind(mt),t.clearTimeoutFn=mt.clearTimeout.bind(mt))}function _t(){return Date.now().toString(36).substring(3)+Math.random().toString(36).substring(2,5)}class Ct extends Error{constructor(t,e,s){super(t),this.description=e,this.context=s,this.type="TransportError"}}class xt extends gt{constructor(t){super(),this.writable=!1,vt(this,t),this.opts=t,this.query=t.query,this.socket=t.socket,this.supportsBinary=!t.forceBase64}onError(t,e,s){return super.emitReserved("error",new Ct(t,e,s)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return"opening"!==this.readyState&&"open"!==this.readyState||(this.doClose(),this.onClose()),this}send(t){"open"===this.readyState&&this.write(t)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(t){const e=at(t,this.socket.binaryType);this.onPacket(e)}onPacket(t){super.emitReserved("packet",t)}onClose(t){this.readyState="closed",super.emitReserved("close",t)}pause(t){}createUri(t,e={}){return t+"://"+this._hostname()+this._port()+this.opts.path+this._query(e)}_hostname(){const t=this.opts.hostname;return-1===t.indexOf(":")?t:"["+t+"]"}_port(){return this.opts.port&&(this.opts.secure&&Number(443!==this.opts.port)||!this.opts.secure&&80!==Number(this.opts.port))?":"+this.opts.port:""}_query(t){const e=function(t){let e="";for(let s in t)t.hasOwnProperty(s)&&(e.length&&(e+="&"),e+=encodeURIComponent(s)+"="+encodeURIComponent(t[s]));return e}(t);return e.length?"?"+e:""}}class kt extends xt{constructor(){super(...arguments),this._polling=!1}get name(){return"polling"}doOpen(){this._poll()}pause(t){this.readyState="pausing";const e=()=>{this.readyState="paused",t()};if(this._polling||!this.writable){let t=0;this._polling&&(t++,this.once("pollComplete",(function(){--t||e()}))),this.writable||(t++,this.once("drain",(function(){--t||e()})))}else e()}_poll(){this._polling=!0,this.doPoll(),this.emitReserved("poll")}onData(t){((t,e)=>{const s=t.split(lt),i=[];for(let t=0;t<s.length;t++){const n=at(s[t],e);if(i.push(n),"error"===n.type)break}return i})(t,this.socket.binaryType).forEach((t=>{if("opening"===this.readyState&&"open"===t.type&&this.onOpen(),"close"===t.type)return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(t)})),"closed"!==this.readyState&&(this._polling=!1,this.emitReserved("pollComplete"),"open"===this.readyState&&this._poll())}doClose(){const t=()=>{this.write([{type:"close"}])};"open"===this.readyState?t():this.once("open",t)}write(t){this.writable=!1,((t,e)=>{const s=t.length,i=new Array(s);let n=0;t.forEach(((t,o)=>{et(t,!1,(t=>{i[o]=t,++n===s&&e(i.join(lt))}))}))})(t,(t=>{this.doWrite(t,(()=>{this.writable=!0,this.emitReserved("drain")}))}))}uri(){const t=this.opts.secure?"https":"http",e=this.query||{};return!1!==this.opts.timestampRequests&&(e[this.opts.timestampParam]=_t()),this.supportsBinary||e.sid||(e.b64=1),this.createUri(t,e)}}let Pt=!1;try{Pt="undefined"!=typeof XMLHttpRequest&&"withCredentials"in new XMLHttpRequest}catch(t){}const Tt=Pt;function Et(){}class St extends kt{constructor(t){if(super(t),"undefined"!=typeof location){const e="https:"===location.protocol;let s=location.port;s||(s=e?"443":"80"),this.xd="undefined"!=typeof location&&t.hostname!==location.hostname||s!==t.port}}doWrite(t,e){const s=this.request({method:"POST",data:t});s.on("success",e),s.on("error",((t,e)=>{this.onError("xhr post error",t,e)}))}doPoll(){const t=this.request();t.on("data",this.onData.bind(this)),t.on("error",((t,e)=>{this.onError("xhr poll error",t,e)})),this.pollXhr=t}}class Ot extends gt{constructor(t,e,s){super(),this.createRequest=t,vt(this,s),this._opts=s,this._method=s.method||"GET",this._uri=e,this._data=void 0!==s.data?s.data:null,this._create()}_create(){var t;const e=yt(this._opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");e.xdomain=!!this._opts.xd;const s=this._xhr=this.createRequest(e);try{s.open(this._method,this._uri,!0);try{if(this._opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let t in this._opts.extraHeaders)this._opts.extraHeaders.hasOwnProperty(t)&&s.setRequestHeader(t,this._opts.extraHeaders[t])}}catch(t){}if("POST"===this._method)try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch(t){}try{s.setRequestHeader("Accept","*/*")}catch(t){}null===(t=this._opts.cookieJar)||void 0===t||t.addCookies(s),"withCredentials"in s&&(s.withCredentials=this._opts.withCredentials),this._opts.requestTimeout&&(s.timeout=this._opts.requestTimeout),s.onreadystatechange=()=>{var t;3===s.readyState&&(null===(t=this._opts.cookieJar)||void 0===t||t.parseCookies(s.getResponseHeader("set-cookie"))),4===s.readyState&&(200===s.status||1223===s.status?this._onLoad():this.setTimeoutFn((()=>{this._onError("number"==typeof s.status?s.status:0)}),0))},s.send(this._data)}catch(t){return void this.setTimeoutFn((()=>{this._onError(t)}),0)}"undefined"!=typeof document&&(this._index=Ot.requestsCount++,Ot.requests[this._index]=this)}_onError(t){this.emitReserved("error",t,this._xhr),this._cleanup(!0)}_cleanup(t){if(void 0!==this._xhr&&null!==this._xhr){if(this._xhr.onreadystatechange=Et,t)try{this._xhr.abort()}catch(t){}"undefined"!=typeof document&&delete Ot.requests[this._index],this._xhr=null}}_onLoad(){const t=this._xhr.responseText;null!==t&&(this.emitReserved("data",t),this.emitReserved("success"),this._cleanup())}abort(){this._cleanup()}}function At(){for(let t in Ot.requests)Ot.requests.hasOwnProperty(t)&&Ot.requests[t].abort()}Ot.requestsCount=0,Ot.requests={},"undefined"!=typeof document&&("function"==typeof attachEvent?attachEvent("onunload",At):"function"==typeof addEventListener&&addEventListener("onpagehide"in mt?"pagehide":"unload",At,!1));const Rt=function(){const t=Mt({xdomain:!1});return t&&null!==t.responseType}();function Mt(t){const e=t.xdomain;try{if("undefined"!=typeof XMLHttpRequest&&(!e||Tt))return new XMLHttpRequest}catch(t){}if(!e)try{return new(mt[["Active"].concat("Object").join("X")])("Microsoft.XMLHTTP")}catch(t){}}const Bt="undefined"!=typeof navigator&&"string"==typeof navigator.product&&"reactnative"===navigator.product.toLowerCase();class Wt extends xt{get name(){return"websocket"}doOpen(){const t=this.uri(),e=this.opts.protocols,s=Bt?{}:yt(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(s.headers=this.opts.extraHeaders);try{this.ws=this.createSocket(t,e,s)}catch(t){return this.emitReserved("error",t)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=t=>this.onClose({description:"websocket connection closed",context:t}),this.ws.onmessage=t=>this.onData(t.data),this.ws.onerror=t=>this.onError("websocket error",t)}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],i=e===t.length-1;et(s,this.supportsBinary,(t=>{try{this.doWrite(s,t)}catch(t){}i&&ft((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){void 0!==this.ws&&(this.ws.onerror=()=>{},this.ws.close(),this.ws=null)}uri(){const t=this.opts.secure?"wss":"ws",e=this.query||{};return this.opts.timestampRequests&&(e[this.opts.timestampParam]=_t()),this.supportsBinary||(e.b64=1),this.createUri(t,e)}}const Lt=mt.WebSocket||mt.MozWebSocket,jt={websocket:class extends Wt{createSocket(t,e,s){return Bt?new Lt(t,e,s):e?new Lt(t,e):new Lt(t)}doWrite(t,e){this.ws.send(e)}},webtransport:class extends xt{get name(){return"webtransport"}doOpen(){try{this._transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name])}catch(t){return this.emitReserved("error",t)}this._transport.closed.then((()=>{this.onClose()})).catch((t=>{this.onError("webtransport error",t)})),this._transport.ready.then((()=>{this._transport.createBidirectionalStream().then((t=>{const e=function(t,e){dt||(dt=new TextDecoder);const s=[];let i=0,n=-1,o=!1;return new TransformStream({transform(r,a){for(s.push(r);;){if(0===i){if(ut(s)<1)break;const t=pt(s,1);o=!(128&~t[0]),n=127&t[0],i=n<126?3:126===n?1:2}else if(1===i){if(ut(s)<2)break;const t=pt(s,2);n=new DataView(t.buffer,t.byteOffset,t.length).getUint16(0),i=3}else if(2===i){if(ut(s)<8)break;const t=pt(s,8),e=new DataView(t.buffer,t.byteOffset,t.length),o=e.getUint32(0);if(o>Math.pow(2,21)-1){a.enqueue(X);break}n=o*Math.pow(2,32)+e.getUint32(4),i=3}else{if(ut(s)<n)break;const t=pt(s,n);a.enqueue(at(o?t:dt.decode(t),e)),i=0}if(0===n||n>t){a.enqueue(X);break}}}})}(Number.MAX_SAFE_INTEGER,this.socket.binaryType),s=t.readable.pipeThrough(e).getReader(),i=new TransformStream({transform(t,e){!function(t,e){Q&&t.data instanceof Blob?t.data.arrayBuffer().then(it).then(e):Z&&(t.data instanceof ArrayBuffer||tt(t.data))?e(it(t.data)):et(t,!1,(t=>{nt||(nt=new TextEncoder),e(nt.encode(t))}))}(t,(s=>{const i=s.length;let n;if(i<126)n=new Uint8Array(1),new DataView(n.buffer).setUint8(0,i);else if(i<65536){n=new Uint8Array(3);const t=new DataView(n.buffer);t.setUint8(0,126),t.setUint16(1,i)}else{n=new Uint8Array(9);const t=new DataView(n.buffer);t.setUint8(0,127),t.setBigUint64(1,BigInt(i))}t.data&&"string"!=typeof t.data&&(n[0]|=128),e.enqueue(n),e.enqueue(s)}))}});i.readable.pipeTo(t.writable),this._writer=i.writable.getWriter();const n=()=>{s.read().then((({done:t,value:e})=>{t||(this.onPacket(e),n())})).catch((t=>{}))};n();const o={type:"open"};this.query.sid&&(o.data=`{"sid":"${this.query.sid}"}`),this._writer.write(o).then((()=>this.onOpen()))}))}))}write(t){this.writable=!1;for(let e=0;e<t.length;e++){const s=t[e],i=e===t.length-1;this._writer.write(s).then((()=>{i&&ft((()=>{this.writable=!0,this.emitReserved("drain")}),this.setTimeoutFn)}))}}doClose(){var t;null===(t=this._transport)||void 0===t||t.close()}},polling:class extends St{constructor(t){super(t);const e=t&&t.forceBase64;this.supportsBinary=Rt&&!e}request(t={}){return Object.assign(t,{xd:this.xd},this.opts),new Ot(Mt,this.uri(),t)}}},Nt=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Dt=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function Gt(t){if(t.length>8e3)throw"URI too long";const e=t,s=t.indexOf("["),i=t.indexOf("]");-1!=s&&-1!=i&&(t=t.substring(0,s)+t.substring(s,i).replace(/:/g,";")+t.substring(i,t.length));let n=Nt.exec(t||""),o={},r=14;for(;r--;)o[Dt[r]]=n[r]||"";return-1!=s&&-1!=i&&(o.source=e,o.host=o.host.substring(1,o.host.length-1).replace(/;/g,":"),o.authority=o.authority.replace("[","").replace("]","").replace(/;/g,":"),o.ipv6uri=!0),o.pathNames=function(t,e){const s=e.replace(/\/{2,9}/g,"/").split("/");return"/"!=e.slice(0,1)&&0!==e.length||s.splice(0,1),"/"==e.slice(-1)&&s.splice(s.length-1,1),s}(0,o.path),o.queryKey=function(t,e){const s={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(function(t,e,i){e&&(s[e]=i)})),s}(0,o.query),o}const qt="function"==typeof addEventListener&&"function"==typeof removeEventListener,It=[];qt&&addEventListener("offline",(()=>{It.forEach((t=>t()))}),!1);class Ut extends gt{constructor(t,e){if(super(),this.binaryType="arraybuffer",this.writeBuffer=[],this._prevBufferLen=0,this._pingInterval=-1,this._pingTimeout=-1,this._maxPayload=-1,this._pingTimeoutTime=1/0,t&&"object"==typeof t&&(e=t,t=null),t){const s=Gt(t);e.hostname=s.host,e.secure="https"===s.protocol||"wss"===s.protocol,e.port=s.port,s.query&&(e.query=s.query)}else e.host&&(e.hostname=Gt(e.host).host);vt(this,e),this.secure=null!=e.secure?e.secure:"undefined"!=typeof location&&"https:"===location.protocol,e.hostname&&!e.port&&(e.port=this.secure?"443":"80"),this.hostname=e.hostname||("undefined"!=typeof location?location.hostname:"localhost"),this.port=e.port||("undefined"!=typeof location&&location.port?location.port:this.secure?"443":"80"),this.transports=[],this._transportsByName={},e.transports.forEach((t=>{const e=t.prototype.name;this.transports.push(e),this._transportsByName[e]=t})),this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},e),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),"string"==typeof this.opts.query&&(this.opts.query=function(t){let e={},s=t.split("&");for(let t=0,i=s.length;t<i;t++){let i=s[t].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}(this.opts.query)),qt&&(this.opts.closeOnBeforeunload&&(this._beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this._beforeunloadEventListener,!1)),"localhost"!==this.hostname&&(this._offlineEventListener=()=>{this._onClose("transport close",{description:"network connection lost"})},It.push(this._offlineEventListener))),this.opts.withCredentials&&(this._cookieJar=void 0),this._open()}createTransport(t){const e=Object.assign({},this.opts.query);e.EIO=4,e.transport=t,this.id&&(e.sid=this.id);const s=Object.assign({},this.opts,{query:e,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new this._transportsByName[t](s)}_open(){if(0===this.transports.length)return void this.setTimeoutFn((()=>{this.emitReserved("error","No transports available")}),0);const t=this.opts.rememberUpgrade&&Ut.priorWebsocketSuccess&&-1!==this.transports.indexOf("websocket")?"websocket":this.transports[0];this.readyState="opening";const e=this.createTransport(t);e.open(),this.setTransport(e)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this._onDrain.bind(this)).on("packet",this._onPacket.bind(this)).on("error",this._onError.bind(this)).on("close",(t=>this._onClose("transport close",t)))}onOpen(){this.readyState="open",Ut.priorWebsocketSuccess="websocket"===this.transport.name,this.emitReserved("open"),this.flush()}_onPacket(t){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState)switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this._sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong"),this._resetPingTimeout();break;case"error":const e=new Error("server error");e.code=t.data,this._onError(e);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data)}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this._pingInterval=t.pingInterval,this._pingTimeout=t.pingTimeout,this._maxPayload=t.maxPayload,this.onOpen(),"closed"!==this.readyState&&this._resetPingTimeout()}_resetPingTimeout(){this.clearTimeoutFn(this._pingTimeoutTimer);const t=this._pingInterval+this._pingTimeout;this._pingTimeoutTime=Date.now()+t,this._pingTimeoutTimer=this.setTimeoutFn((()=>{this._onClose("ping timeout")}),t),this.opts.autoUnref&&this._pingTimeoutTimer.unref()}_onDrain(){this.writeBuffer.splice(0,this._prevBufferLen),this._prevBufferLen=0,0===this.writeBuffer.length?this.emitReserved("drain"):this.flush()}flush(){if("closed"!==this.readyState&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){const t=this._getWritablePackets();this.transport.send(t),this._prevBufferLen=t.length,this.emitReserved("flush")}}_getWritablePackets(){if(!(this._maxPayload&&"polling"===this.transport.name&&this.writeBuffer.length>1))return this.writeBuffer;let t=1;for(let s=0;s<this.writeBuffer.length;s++){const i=this.writeBuffer[s].data;if(i&&(t+="string"==typeof(e=i)?function(t){let e=0,s=0;for(let i=0,n=t.length;i<n;i++)e=t.charCodeAt(i),e<128?s+=1:e<2048?s+=2:e<55296||e>=57344?s+=3:(i++,s+=4);return s}(e):Math.ceil(1.33*(e.byteLength||e.size))),s>0&&t>this._maxPayload)return this.writeBuffer.slice(0,s);t+=2}var e;return this.writeBuffer}_hasPingExpired(){if(!this._pingTimeoutTime)return!0;const t=Date.now()>this._pingTimeoutTime;return t&&(this._pingTimeoutTime=0,ft((()=>{this._onClose("ping timeout")}),this.setTimeoutFn)),t}write(t,e,s){return this._sendPacket("message",t,e,s),this}send(t,e,s){return this._sendPacket("message",t,e,s),this}_sendPacket(t,e,s,i){if("function"==typeof e&&(i=e,e=void 0),"function"==typeof s&&(i=s,s=null),"closing"===this.readyState||"closed"===this.readyState)return;(s=s||{}).compress=!1!==s.compress;const n={type:t,data:e,options:s};this.emitReserved("packetCreate",n),this.writeBuffer.push(n),i&&this.once("flush",i),this.flush()}close(){const t=()=>{this._onClose("forced close"),this.transport.close()},e=()=>{this.off("upgrade",e),this.off("upgradeError",e),t()},s=()=>{this.once("upgrade",e),this.once("upgradeError",e)};return"opening"!==this.readyState&&"open"!==this.readyState||(this.readyState="closing",this.writeBuffer.length?this.once("drain",(()=>{this.upgrading?s():t()})):this.upgrading?s():t()),this}_onError(t){if(Ut.priorWebsocketSuccess=!1,this.opts.tryAllTransports&&this.transports.length>1&&"opening"===this.readyState)return this.transports.shift(),this._open();this.emitReserved("error",t),this._onClose("transport error",t)}_onClose(t,e){if("opening"===this.readyState||"open"===this.readyState||"closing"===this.readyState){if(this.clearTimeoutFn(this._pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),qt&&(this._beforeunloadEventListener&&removeEventListener("beforeunload",this._beforeunloadEventListener,!1),this._offlineEventListener)){const t=It.indexOf(this._offlineEventListener);-1!==t&&It.splice(t,1)}this.readyState="closed",this.id=null,this.emitReserved("close",t,e),this.writeBuffer=[],this._prevBufferLen=0}}}Ut.protocol=4;class zt extends Ut{constructor(){super(...arguments),this._upgrades=[]}onOpen(){if(super.onOpen(),"open"===this.readyState&&this.opts.upgrade)for(let t=0;t<this._upgrades.length;t++)this._probe(this._upgrades[t])}_probe(t){let e=this.createTransport(t),s=!1;Ut.priorWebsocketSuccess=!1;const i=()=>{s||(e.send([{type:"ping",data:"probe"}]),e.once("packet",(t=>{if(!s)if("pong"===t.type&&"probe"===t.data){if(this.upgrading=!0,this.emitReserved("upgrading",e),!e)return;Ut.priorWebsocketSuccess="websocket"===e.name,this.transport.pause((()=>{s||"closed"!==this.readyState&&(c(),this.setTransport(e),e.send([{type:"upgrade"}]),this.emitReserved("upgrade",e),e=null,this.upgrading=!1,this.flush())}))}else{const t=new Error("probe error");t.transport=e.name,this.emitReserved("upgradeError",t)}})))};function n(){s||(s=!0,c(),e.close(),e=null)}const o=t=>{const s=new Error("probe error: "+t);s.transport=e.name,n(),this.emitReserved("upgradeError",s)};function r(){o("transport closed")}function a(){o("socket closed")}function h(t){e&&t.name!==e.name&&n()}const c=()=>{e.removeListener("open",i),e.removeListener("error",o),e.removeListener("close",r),this.off("close",a),this.off("upgrading",h)};e.once("open",i),e.once("error",o),e.once("close",r),this.once("close",a),this.once("upgrading",h),-1!==this._upgrades.indexOf("webtransport")&&"webtransport"!==t?this.setTimeoutFn((()=>{s||e.open()}),200):e.open()}onHandshake(t){this._upgrades=this._filterUpgrades(t.upgrades),super.onHandshake(t)}_filterUpgrades(t){const e=[];for(let s=0;s<t.length;s++)~this.transports.indexOf(t[s])&&e.push(t[s]);return e}}class Ft extends zt{constructor(t,e={}){const s="object"==typeof t?t:e;(!s.transports||s.transports&&"string"==typeof s.transports[0])&&(s.transports=(s.transports||["polling","websocket","webtransport"]).map((t=>jt[t])).filter((t=>!!t))),super(t,s)}}const Kt="function"==typeof ArrayBuffer,Vt=Object.prototype.toString,Ht="function"==typeof Blob||"undefined"!=typeof Blob&&"[object BlobConstructor]"===Vt.call(Blob),$t="function"==typeof File||"undefined"!=typeof File&&"[object FileConstructor]"===Vt.call(File);function Yt(t){return Kt&&(t instanceof ArrayBuffer||(t=>"function"==typeof ArrayBuffer.isView?ArrayBuffer.isView(t):t.buffer instanceof ArrayBuffer)(t))||Ht&&t instanceof Blob||$t&&t instanceof File}function Jt(t,e){if(!t||"object"!=typeof t)return!1;if(Array.isArray(t)){for(let e=0,s=t.length;e<s;e++)if(Jt(t[e]))return!0;return!1}if(Yt(t))return!0;if(t.toJSON&&"function"==typeof t.toJSON&&1===arguments.length)return Jt(t.toJSON(),!0);for(const e in t)if(Object.prototype.hasOwnProperty.call(t,e)&&Jt(t[e]))return!0;return!1}function Xt(t){const e=[],s=t.data,i=t;return i.data=Qt(s,e),i.attachments=e.length,{packet:i,buffers:e}}function Qt(t,e){if(!t)return t;if(Yt(t)){const s={_placeholder:!0,num:e.length};return e.push(t),s}if(Array.isArray(t)){const s=new Array(t.length);for(let i=0;i<t.length;i++)s[i]=Qt(t[i],e);return s}if("object"==typeof t&&!(t instanceof Date)){const s={};for(const i in t)Object.prototype.hasOwnProperty.call(t,i)&&(s[i]=Qt(t[i],e));return s}return t}function Zt(t,e){return t.data=te(t.data,e),delete t.attachments,t}function te(t,e){if(!t)return t;if(t&&!0===t._placeholder){if("number"==typeof t.num&&t.num>=0&&t.num<e.length)return e[t.num];throw new Error("illegal attachments")}if(Array.isArray(t))for(let s=0;s<t.length;s++)t[s]=te(t[s],e);else if("object"==typeof t)for(const s in t)Object.prototype.hasOwnProperty.call(t,s)&&(t[s]=te(t[s],e));return t}const ee=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],se=5;var ie;!function(t){t[t.CONNECT=0]="CONNECT",t[t.DISCONNECT=1]="DISCONNECT",t[t.EVENT=2]="EVENT",t[t.ACK=3]="ACK",t[t.CONNECT_ERROR=4]="CONNECT_ERROR",t[t.BINARY_EVENT=5]="BINARY_EVENT",t[t.BINARY_ACK=6]="BINARY_ACK"}(ie||(ie={}));class ne{constructor(t){this.replacer=t}encode(t){return t.type!==ie.EVENT&&t.type!==ie.ACK||!Jt(t)?[this.encodeAsString(t)]:this.encodeAsBinary({type:t.type===ie.EVENT?ie.BINARY_EVENT:ie.BINARY_ACK,nsp:t.nsp,data:t.data,id:t.id})}encodeAsString(t){let e=""+t.type;return t.type!==ie.BINARY_EVENT&&t.type!==ie.BINARY_ACK||(e+=t.attachments+"-"),t.nsp&&"/"!==t.nsp&&(e+=t.nsp+","),null!=t.id&&(e+=t.id),null!=t.data&&(e+=JSON.stringify(t.data,this.replacer)),e}encodeAsBinary(t){const e=Xt(t),s=this.encodeAsString(e.packet),i=e.buffers;return i.unshift(s),i}}function oe(t){return"[object Object]"===Object.prototype.toString.call(t)}class re extends gt{constructor(t){super(),this.reviver=t}add(t){let e;if("string"==typeof t){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");e=this.decodeString(t);const s=e.type===ie.BINARY_EVENT;s||e.type===ie.BINARY_ACK?(e.type=s?ie.EVENT:ie.ACK,this.reconstructor=new ae(e),0===e.attachments&&super.emitReserved("decoded",e)):super.emitReserved("decoded",e)}else{if(!Yt(t)&&!t.base64)throw new Error("Unknown type: "+t);if(!this.reconstructor)throw new Error("got binary data when not reconstructing a packet");e=this.reconstructor.takeBinaryData(t),e&&(this.reconstructor=null,super.emitReserved("decoded",e))}}decodeString(t){let e=0;const s={type:Number(t.charAt(0))};if(void 0===ie[s.type])throw new Error("unknown packet type "+s.type);if(s.type===ie.BINARY_EVENT||s.type===ie.BINARY_ACK){const i=e+1;for(;"-"!==t.charAt(++e)&&e!=t.length;);const n=t.substring(i,e);if(n!=Number(n)||"-"!==t.charAt(e))throw new Error("Illegal attachments");s.attachments=Number(n)}if("/"===t.charAt(e+1)){const i=e+1;for(;++e&&","!==t.charAt(e)&&e!==t.length;);s.nsp=t.substring(i,e)}else s.nsp="/";const i=t.charAt(e+1);if(""!==i&&Number(i)==i){const i=e+1;for(;++e;){const s=t.charAt(e);if(null==s||Number(s)!=s){--e;break}if(e===t.length)break}s.id=Number(t.substring(i,e+1))}if(t.charAt(++e)){const i=this.tryParse(t.substr(e));if(!re.isPayloadValid(s.type,i))throw new Error("invalid payload");s.data=i}return s}tryParse(t){try{return JSON.parse(t,this.reviver)}catch(t){return!1}}static isPayloadValid(t,e){switch(t){case ie.CONNECT:return oe(e);case ie.DISCONNECT:return void 0===e;case ie.CONNECT_ERROR:return"string"==typeof e||oe(e);case ie.EVENT:case ie.BINARY_EVENT:return Array.isArray(e)&&("number"==typeof e[0]||"string"==typeof e[0]&&-1===ee.indexOf(e[0]));case ie.ACK:case ie.BINARY_ACK:return Array.isArray(e)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}}class ae{constructor(t){this.packet=t,this.buffers=[],this.reconPack=t}takeBinaryData(t){if(this.buffers.push(t),this.buffers.length===this.reconPack.attachments){const t=Zt(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}}function he(t,e,s){return t.on(e,s),function(){t.off(e,s)}}const ce=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1});class le extends gt{constructor(t,e,s){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=t,this.nsp=e,s&&s.auth&&(this.auth=s.auth),this._opts=Object.assign({},s),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;const t=this.io;this.subs=[he(t,"open",this.onopen.bind(this)),he(t,"packet",this.onpacket.bind(this)),he(t,"error",this.onerror.bind(this)),he(t,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected||(this.subEvents(),this.io._reconnecting||this.io.open(),"open"===this.io._readyState&&this.onopen()),this}open(){return this.connect()}send(...t){return t.unshift("message"),this.emit.apply(this,t),this}emit(t,...e){var s,i,n;if(ce.hasOwnProperty(t))throw new Error('"'+t.toString()+'" is a reserved event name');if(e.unshift(t),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(e),this;const o={type:ie.EVENT,data:e,options:{}};if(o.options.compress=!1!==this.flags.compress,"function"==typeof e[e.length-1]){const t=this.ids++,s=e.pop();this._registerAckCallback(t,s),o.id=t}const r=null===(i=null===(s=this.io.engine)||void 0===s?void 0:s.transport)||void 0===i?void 0:i.writable,a=this.connected&&!(null===(n=this.io.engine)||void 0===n?void 0:n._hasPingExpired());return this.flags.volatile&&!r||(a?(this.notifyOutgoingListeners(o),this.packet(o)):this.sendBuffer.push(o)),this.flags={},this}_registerAckCallback(t,e){var s;const i=null!==(s=this.flags.timeout)&&void 0!==s?s:this._opts.ackTimeout;if(void 0===i)return void(this.acks[t]=e);const n=this.io.setTimeoutFn((()=>{delete this.acks[t];for(let e=0;e<this.sendBuffer.length;e++)this.sendBuffer[e].id===t&&this.sendBuffer.splice(e,1);e.call(this,new Error("operation has timed out"))}),i),o=(...t)=>{this.io.clearTimeoutFn(n),e.apply(this,t)};o.withError=!0,this.acks[t]=o}emitWithAck(t,...e){return new Promise(((s,i)=>{const n=(t,e)=>t?i(t):s(e);n.withError=!0,e.push(n),this.emit(t,...e)}))}_addToQueue(t){let e;"function"==typeof t[t.length-1]&&(e=t.pop());const s={id:this._queueSeq++,tryCount:0,pending:!1,args:t,flags:Object.assign({fromQueue:!0},this.flags)};t.push(((t,...i)=>{if(s===this._queue[0])return null!==t?s.tryCount>this._opts.retries&&(this._queue.shift(),e&&e(t)):(this._queue.shift(),e&&e(null,...i)),s.pending=!1,this._drainQueue()})),this._queue.push(s),this._drainQueue()}_drainQueue(t=!1){if(!this.connected||0===this._queue.length)return;const e=this._queue[0];e.pending&&!t||(e.pending=!0,e.tryCount++,this.flags=e.flags,this.emit.apply(this,e.args))}packet(t){t.nsp=this.nsp,this.io._packet(t)}onopen(){"function"==typeof this.auth?this.auth((t=>{this._sendConnectPacket(t)})):this._sendConnectPacket(this.auth)}_sendConnectPacket(t){this.packet({type:ie.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},t):t})}onerror(t){this.connected||this.emitReserved("connect_error",t)}onclose(t,e){this.connected=!1,delete this.id,this.emitReserved("disconnect",t,e),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach((t=>{if(!this.sendBuffer.some((e=>String(e.id)===t))){const e=this.acks[t];delete this.acks[t],e.withError&&e.call(this,new Error("socket has been disconnected"))}}))}onpacket(t){if(t.nsp===this.nsp)switch(t.type){case ie.CONNECT:t.data&&t.data.sid?this.onconnect(t.data.sid,t.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case ie.EVENT:case ie.BINARY_EVENT:this.onevent(t);break;case ie.ACK:case ie.BINARY_ACK:this.onack(t);break;case ie.DISCONNECT:this.ondisconnect();break;case ie.CONNECT_ERROR:this.destroy();const e=new Error(t.data.message);e.data=t.data.data,this.emitReserved("connect_error",e)}}onevent(t){const e=t.data||[];null!=t.id&&e.push(this.ack(t.id)),this.connected?this.emitEvent(e):this.receiveBuffer.push(Object.freeze(e))}emitEvent(t){if(this._anyListeners&&this._anyListeners.length){const e=this._anyListeners.slice();for(const s of e)s.apply(this,t)}super.emit.apply(this,t),this._pid&&t.length&&"string"==typeof t[t.length-1]&&(this._lastOffset=t[t.length-1])}ack(t){const e=this;let s=!1;return function(...i){s||(s=!0,e.packet({type:ie.ACK,id:t,data:i}))}}onack(t){const e=this.acks[t.id];"function"==typeof e&&(delete this.acks[t.id],e.withError&&t.data.unshift(null),e.apply(this,t.data))}onconnect(t,e){this.id=t,this.recovered=e&&this._pid===e,this._pid=e,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach((t=>this.emitEvent(t))),this.receiveBuffer=[],this.sendBuffer.forEach((t=>{this.notifyOutgoingListeners(t),this.packet(t)})),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach((t=>t())),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:ie.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(t){return this.flags.compress=t,this}get volatile(){return this.flags.volatile=!0,this}timeout(t){return this.flags.timeout=t,this}onAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(t),this}prependAny(t){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(t),this}offAny(t){if(!this._anyListeners)return this;if(t){const e=this._anyListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(t),this}prependAnyOutgoing(t){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(t),this}offAnyOutgoing(t){if(!this._anyOutgoingListeners)return this;if(t){const e=this._anyOutgoingListeners;for(let s=0;s<e.length;s++)if(t===e[s])return e.splice(s,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(t){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){const e=this._anyOutgoingListeners.slice();for(const s of e)s.apply(this,t.data)}}}function de(t){t=t||{},this.ms=t.min||100,this.max=t.max||1e4,this.factor=t.factor||2,this.jitter=t.jitter>0&&t.jitter<=1?t.jitter:0,this.attempts=0}de.prototype.duration=function(){var t=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),s=Math.floor(e*this.jitter*t);t=1&Math.floor(10*e)?t+s:t-s}return 0|Math.min(t,this.max)},de.prototype.reset=function(){this.attempts=0},de.prototype.setMin=function(t){this.ms=t},de.prototype.setMax=function(t){this.max=t},de.prototype.setJitter=function(t){this.jitter=t};class ue extends gt{constructor(t,e){var i;super(),this.nsps={},this.subs=[],t&&"object"==typeof t&&(e=t,t=void 0),(e=e||{}).path=e.path||"/socket.io",this.opts=e,vt(this,e),this.reconnection(!1!==e.reconnection),this.reconnectionAttempts(e.reconnectionAttempts||1/0),this.reconnectionDelay(e.reconnectionDelay||1e3),this.reconnectionDelayMax(e.reconnectionDelayMax||5e3),this.randomizationFactor(null!==(i=e.randomizationFactor)&&void 0!==i?i:.5),this.backoff=new de({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(null==e.timeout?2e4:e.timeout),this._readyState="closed",this.uri=t;const n=e.parser||s;this.encoder=new n.Encoder,this.decoder=new n.Decoder,this._autoConnect=!1!==e.autoConnect,this._autoConnect&&this.open()}reconnection(t){return arguments.length?(this._reconnection=!!t,t||(this.skipReconnect=!0),this):this._reconnection}reconnectionAttempts(t){return void 0===t?this._reconnectionAttempts:(this._reconnectionAttempts=t,this)}reconnectionDelay(t){var e;return void 0===t?this._reconnectionDelay:(this._reconnectionDelay=t,null===(e=this.backoff)||void 0===e||e.setMin(t),this)}randomizationFactor(t){var e;return void 0===t?this._randomizationFactor:(this._randomizationFactor=t,null===(e=this.backoff)||void 0===e||e.setJitter(t),this)}reconnectionDelayMax(t){var e;return void 0===t?this._reconnectionDelayMax:(this._reconnectionDelayMax=t,null===(e=this.backoff)||void 0===e||e.setMax(t),this)}timeout(t){return arguments.length?(this._timeout=t,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&0===this.backoff.attempts&&this.reconnect()}open(t){if(~this._readyState.indexOf("open"))return this;this.engine=new Ft(this.uri,this.opts);const e=this.engine,s=this;this._readyState="opening",this.skipReconnect=!1;const i=he(e,"open",(function(){s.onopen(),t&&t()})),n=e=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",e),t?t(e):this.maybeReconnectOnOpen()},o=he(e,"error",n);if(!1!==this._timeout){const t=this._timeout,s=this.setTimeoutFn((()=>{i(),n(new Error("timeout")),e.close()}),t);this.opts.autoUnref&&s.unref(),this.subs.push((()=>{this.clearTimeoutFn(s)}))}return this.subs.push(i),this.subs.push(o),this}connect(t){return this.open(t)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");const t=this.engine;this.subs.push(he(t,"ping",this.onping.bind(this)),he(t,"data",this.ondata.bind(this)),he(t,"error",this.onerror.bind(this)),he(t,"close",this.onclose.bind(this)),he(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(t){try{this.decoder.add(t)}catch(t){this.onclose("parse error",t)}}ondecoded(t){ft((()=>{this.emitReserved("packet",t)}),this.setTimeoutFn)}onerror(t){this.emitReserved("error",t)}socket(t,e){let s=this.nsps[t];return s?this._autoConnect&&!s.active&&s.connect():(s=new le(this,t,e),this.nsps[t]=s),s}_destroy(t){const e=Object.keys(this.nsps);for(const t of e)if(this.nsps[t].active)return;this._close()}_packet(t){const e=this.encoder.encode(t);for(let s=0;s<e.length;s++)this.engine.write(e[s],t.options)}cleanup(){this.subs.forEach((t=>t())),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close")}disconnect(){return this._close()}onclose(t,e){var s;this.cleanup(),null===(s=this.engine)||void 0===s||s.close(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",t,e),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;const t=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{const e=this.backoff.duration();this._reconnecting=!0;const s=this.setTimeoutFn((()=>{t.skipReconnect||(this.emitReserved("reconnect_attempt",t.backoff.attempts),t.skipReconnect||t.open((e=>{e?(t._reconnecting=!1,t.reconnect(),this.emitReserved("reconnect_error",e)):t.onreconnect()})))}),e);this.opts.autoUnref&&s.unref(),this.subs.push((()=>{this.clearTimeoutFn(s)}))}}onreconnect(){const t=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",t)}}const pe={};function ge(t,e){"object"==typeof t&&(e=t,t=void 0);const s=function(t,e="",s){let i=t;s=s||"undefined"!=typeof location&&location,null==t&&(t=s.protocol+"//"+s.host),"string"==typeof t&&("/"===t.charAt(0)&&(t="/"===t.charAt(1)?s.protocol+t:s.host+t),/^(https?|wss?):\/\//.test(t)||(t=void 0!==s?s.protocol+"//"+t:"https://"+t),i=Gt(t)),i.port||(/^(http|ws)$/.test(i.protocol)?i.port="80":/^(http|ws)s$/.test(i.protocol)&&(i.port="443")),i.path=i.path||"/";const n=-1!==i.host.indexOf(":")?"["+i.host+"]":i.host;return i.id=i.protocol+"://"+n+":"+i.port+e,i.href=i.protocol+"://"+n+(s&&s.port===i.port?"":":"+i.port),i}(t,(e=e||{}).path||"/socket.io"),i=s.source,n=s.id,o=s.path,r=pe[n]&&o in pe[n].nsps;let a;return e.forceNew||e["force new connection"]||!1===e.multiplex||r?a=new ue(i,e):(pe[n]||(pe[n]=new ue(i,e)),a=pe[n]),s.query&&!e.query&&(e.query=s.queryKey),a.socket(s.path,e)}Object.assign(ge,{Manager:ue,Socket:le,io:ge,connect:ge});class fe extends d{message;constructor(t){super(),this.message=t}}class me extends l{name="ChatPlugin";chatMessages=[];isListening=!1;message="";chatMessageEvent=new u;start(){this.getPlugin(_)?.KeyDownEvent.subscribe(this,"KeyDownEvent"),this.chatMessageEvent.register(this.gameWorld),this.drawChatWriteMessage(">")}update(t){}event(t,e){const s=t;"enter"===s.key?(this.isListening&&this.message.length>0&&(this.sendChatMessage(this.message),this.message=""),this.isListening=!this.isListening):"backspace"===s.key?this.message=this.message.slice(0,-1):"escape"===s.key?(this.isListening=!1,this.message=""):this.isListening&&(this.message+=s.key),this.isListening?this.drawChatWriteMessage(">> "+this.message):this.drawChatWriteMessage(">"),this.getPlugin(k).enable(!this.isListening)}offset=new o(40,800);drawChatWriteMessage(t){this.getPlugin(q).hud.setLabel("chat_write",this.offset,t)}drawChatMessages(){for(;this.chatMessages.length>=5;)this.chatMessages.shift();let t=this.chatMessages.length;for(let e=1;e<=t;e++)this.getPlugin(q).hud.setLabel("chat"+e,new o(this.offset.x,this.offset.y-40*e),": "+this.chatMessages[t-e])}sendChatMessage(t,e=!0){e&&(this.chatMessageEvent.emit(new fe(t)),t.startsWith("/"))?this.executeCommand(t):(this.chatMessages.push(t),this.drawChatMessages())}executeCommand(t){if(t.startsWith("/setname")){const e=t.split(" ")[1];e?(this.getPlugin(k).player.name=e,this.sendChatMessage(`Name changed to ${e}`,!1)):this.sendChatMessage("Usage: /setname <newname>",!1)}else t.startsWith("/help")&&this.sendChatMessage("Available commands: /setname <newname>",!1)}}class ye extends l{name="SlientPlugin";socket;start(){this.getPlugin(me)?.chatMessageEvent.subscribe(this,"chatMessageEvent"),this.socket=ge("http://localhost:3000",{}),this.socket.on("connect",(()=>this.onConnection())),this.socket.on("disconnect",(t=>this.onDisconnection(t))),this.socket.on("chat_message",(t=>this.onChatMessage(t)))}event(t,e){let s=t;this.sendChatMessage(s.message)}onConnection(){console.log("Connected to server")}onDisconnection(t){console.log(`Disconnected from server: ${t}`)}onChatMessage(t){console.log(`Received chat message: ${t}`),this.getPlugin(me)?.sendChatMessage(t,!1)}sendChatMessage(t){this.socket.emit("chat_message",t)}}const we=new Set;document.addEventListener("keydown",(t=>{we.add(t.key.toLowerCase())})),document.addEventListener("keyup",(t=>{we.delete(t.key.toLowerCase())})),async function(t){let e=[];e.push(new x),e.push(new ye),e.push(new me),e.push(new _(we)),e.push(new C(t)),e.push(new B),e.push(new k),e.push(new V),e.push(new P),e.push(new U),e.push(new H),e.push(new $),e.push(new q(t.getContext("2d")));let s=new K(...e);!function t(){requestAnimationFrame(t),s.tick()}()}(document.getElementById("gameCanvas"))})();